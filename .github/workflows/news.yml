name: AI News Generator

on:
  schedule:
    - cron: "0 8 * * *"  # –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 08:00 UTC
  workflow_dispatch:

jobs:
  generate-news:
    runs-on: ubuntu-latest

    steps:
      - name: üõí –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
        uses: actions/checkout@v3

      - name: üêç –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: üì¶ –°—Ç–∞–≤–∏–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É OpenAI
        run: pip install openai

      - name: ü§ñ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º 3 –≥–æ—Ä—è—á–∏—Ö –Ω–æ–≤–æ—Å—Ç–∏
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          import openai, json, datetime

          openai.api_key = "${{ secrets.OPENAI_API_KEY }}"
          today = datetime.date.today().isoformat()

          prompt = (
              "–°–¥–µ–ª–∞–π —Ç—Ä–∏ —Å–∞–º—ã—Ö –≥–æ—Ä—è—á–∏—Ö –∏–≥—Ä–æ–≤—ã—Ö –Ω–æ–≤–æ—Å—Ç–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ (–ø–æ 1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –Ω–∞ –∫–∞–∂–¥—É—é). "
              "–ù–µ –ø–∏—à–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∏ ‚Äî –ø—Ä–æ—Å—Ç–æ –∫–æ—Ä–æ—Ç–∫–∏–µ –Ω–æ–≤–æ—Å—Ç–∏. –ü—Ä–æ–Ω—É–º–µ—Ä—É–π –∏—Ö: 1, 2, 3."
          )

          response = openai.ChatCompletion.create(
              model="gpt-3.5-turbo",
              messages=[
                  {"role": "system", "content": "–¢—ã –Ω–æ–≤–æ—Å—Ç–Ω–æ–π –ò–ò-–±–ª–æ–∫ –¥–ª—è –≥–µ–π–º–µ—Ä—Å–∫–æ–≥–æ —Å–∞–π—Ç–∞."},
                  {"role": "user", "content": prompt}
              ]
          )

          raw = response.choices[0].message['content'].strip()
          lines = [line.strip()[2:].strip() for line in raw.split("\n") if line.strip().startswith(("1", "2", "3"))]

          news_items = [{"date": today, "text": line} for line in lines]

          try:
              with open("news.json", "r", encoding="utf-8") as f:
                  existing = json.load(f)
          except:
              existing = []

          all_news = news_items + existing
          all_news = all_news[:15]  # –º–∞–∫—Å–∏–º—É–º 15 —à—Ç—É–∫

          with open("news.json", "w", encoding="utf-8") as f:
              json.dump(all_news, f, ensure_ascii=False, indent=2)

      - name: üíæ –ö–æ–º–º–∏—Ç–∏–º –Ω–æ–≤–æ—Å—Ç–∏
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add news.json
          git commit -m "üî• –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥–æ—Ä—è—á–∏—Ö –Ω–æ–≤–æ—Å—Ç–µ–π"
          git push
